@page "/"
@page "/prompt-history/{PromptId}"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>@(string.IsNullOrWhiteSpace(PromptId) ? "All Prompts" : "Prompt History")</PageTitle>

@if (string.IsNullOrWhiteSpace(PromptId))
{
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>All Prompts</h2>
            <a href="/edit-prompt" class="btn btn-primary">Create New Prompt</a>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert @(isError ? "alert-danger" : "alert-info") alert-dismissible fade show" role="alert">
                @message
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else
        {
            @if (prompts == null || !prompts.Any())
            {
                <div class="alert alert-info">
                    No prompts found. <a href="/edit-prompt">Create your first prompt</a> to get started.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Prompt ID</th>
                                <th>Version</th>
                                <th>Last Updated</th>
                                <th>Preview</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var prompt in prompts)
                            {
                                <tr>
                                    <td>
                                        <strong>@prompt.PromptId</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">v@prompt.Version</span>
                                    </td>
                                    <td>@prompt.UpdatedAt.ToString("g")</td>
                                    <td>
                                        <small class="text-muted">@TruncateText(prompt.Text, 100)</small>
                                    </td>
                                    <td>
                                        <a href="/edit-prompt/@prompt.PromptId" class="btn btn-sm btn-primary">Edit</a>
                                        <a href="/prompt-history/@prompt.PromptId" class="btn btn-sm btn-info">History</a>
                                        <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(prompt.PromptId)">Delete</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        }
    </div>
}
else
{
<div class="container mt-4">
    <h2>Prompt History - @PromptId</h2>

    <div class="mb-3">
        <a href="/" class="btn btn-secondary">
            ← Back to Prompts
        </a>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert @(isError ? "alert-danger" : "alert-info") alert-dismissible fade show" role="alert">
            @message
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        @if (currentPrompt == null)
        {
            <div class="alert alert-warning">
                Prompt not found. Please create the prompt first.
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-md-4">
                    <h4>Version History</h4>
                    <div class="list-group mb-3">
                        <a href="#" 
                           class="list-group-item list-group-item-action @((selectedOldVersion == currentPrompt.Version || selectedNewVersion == currentPrompt.Version) ? "active" : "")"
                           @onclick="() => SelectVersion(currentPrompt.Version, currentPrompt.Text)">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Current (v@currentPrompt.Version)</h6>
                                <small>@currentPrompt.UpdatedAt.ToString("g")</small>
                            </div>
                            <p class="mb-1 small">@TruncateText(currentPrompt.Text, 100)</p>
                        </a>
                        @foreach (var historyItem in history.OrderByDescending(h => h.Version))
                        {
                            <a href="#" 
                               class="list-group-item list-group-item-action @((selectedOldVersion == historyItem.Version || selectedNewVersion == historyItem.Version) ? "active" : "")"
                               @onclick="() => SelectVersion(historyItem.Version, historyItem.Text)">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Version @historyItem.Version</h6>
                                    <small>@historyItem.ArchivedAt.ToString("g")</small>
                                </div>
                                <p class="mb-1 small">@TruncateText(historyItem.Text, 100)</p>
                            </a>
                        }
                    </div>
                </div>
                <div class="col-md-8">
                    @if (selectedOldVersion > 0 && selectedNewVersion > 0)
                    {
                        <div class="card diff-view-card">
                            <div class="card-header diff-view-header">
                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                    <div>
                                        <h4 class="mb-1" style="font-weight: 600; color: #495057;">Difference View</h4>
                                        <p class="mb-0" style="font-size: 0.875rem; color: #6c757d;">
                                            Comparing: <strong>Version @selectedOldVersion</strong> → <strong>Version @selectedNewVersion</strong>
                                        </p>
                                    </div>
                                    <div class="diff-controls-container d-flex align-items-center gap-3 flex-wrap mt-2 mt-md-0">
                                        <div class="diff-control-group d-flex align-items-center">
                                            <span class="diff-control-label me-2">View Mode:</span>
                                            <div class="btn-group" role="group">
                                                <button type="button" 
                                                        class="btn btn-sm @(selectedViewMode == "SideBySide" ? "btn-primary" : "btn-outline-primary")"
                                                        @onclick='() => SetViewMode("SideBySide")'>
                                                    Side-by-Side
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-sm @(selectedViewMode == "Inline" ? "btn-primary" : "btn-outline-primary")"
                                                        @onclick='() => SetViewMode("Inline")'>
                                                    Inline/Unified
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="diff-control-separator"></div>
                                        
                                        <div class="diff-control-group d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-2" id="showLineNumbers" @bind="showLineNumbers" />
                                            <label for="showLineNumbers" class="diff-control-label mb-0" style="cursor: pointer;">Show Line Numbers</label>
                                        </div>
                                        
                                        <div class="diff-control-separator"></div>
                                        
                                        <button class="btn btn-sm btn-primary" @onclick="() => StateHasChanged()">
                                            Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body diff-view-body">
                                <DiffViewer OldText="@oldVersionText" 
                                           NewText="@newVersionText" 
                                           ViewMode="@currentViewMode" 
                                           ShowLineNumbers="@showLineNumbers" />
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="card empty-state-card">
                            <div class="card-body text-center py-5">
                                <div style="font-size: 3rem; color: #6c757d; opacity: 0.5;">↔</div>
                                <h4 class="mt-3">No Versions Selected</h4>
                                <p class="text-muted">Please select two versions from the history to compare them.</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>
}

<link href="css/diff-styles.css" rel="stylesheet" />

@code {
    [Parameter]
    public string PromptId { get; set; } = string.Empty;

    private Prompt? currentPrompt;
    private List<Models.PromptHistory> history = new();
    private List<Prompt>? prompts;
    private bool isLoading = false;
    private string message = string.Empty;
    private bool isError = false;

    private int selectedOldVersion = 0;
    private int selectedNewVersion = 0;
    private string oldVersionText = string.Empty;
    private string newVersionText = string.Empty;
    private bool showLineNumbers = true;
    private string selectedViewMode = "SideBySide";
    private DiffViewer.DiffViewMode currentViewMode => selectedViewMode == "SideBySide" ? DiffViewer.DiffViewMode.SideBySide : DiffViewer.DiffViewMode.Inline;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        if (string.IsNullOrWhiteSpace(PromptId))
        {
            await LoadPrompts();
        }
        else
        {
            await LoadHistory();
        }
    }

    private async Task LoadPrompts()
    {
        try
        {
            isLoading = true;
            message = string.Empty;
            var response = await Http.GetFromJsonAsync<List<Prompt>>("api/prompts");
            prompts = response ?? new List<Prompt>();
        }
        catch (Exception ex)
        {
            SetMessage($"Error loading prompts: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadHistory()
    {
        if (string.IsNullOrWhiteSpace(PromptId))
        {
            SetMessage("Prompt ID is required.", true);
            return;
        }

        try
        {
            isLoading = true;
            message = string.Empty;

            var promptResponse = await Http.GetAsync($"api/prompts/{PromptId}");
            if (promptResponse.IsSuccessStatusCode)
            {
                currentPrompt = await promptResponse.Content.ReadFromJsonAsync<Prompt>();
            }

            var historyResponse = await Http.GetAsync($"api/prompts/{PromptId}/history");
            if (historyResponse.IsSuccessStatusCode)
            {
                var historyList = await historyResponse.Content.ReadFromJsonAsync<List<PromptHistory>>();
                history = historyList ?? new List<PromptHistory>();
            }

            if (currentPrompt != null)
            {
                // Auto-select current version and previous version if available
                selectedNewVersion = currentPrompt.Version;
                newVersionText = currentPrompt.Text;

                if (history.Any())
                {
                    var latestHistory = history.OrderByDescending(h => h.Version).First();
                    selectedOldVersion = latestHistory.Version;
                    oldVersionText = latestHistory.Text;
                }
            }
            else
            {
                SetMessage("Prompt not found. Please create the prompt first.", true);
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error loading history: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SelectVersion(int version, string text)
    {
        // Toggle selection: if same version selected, clear it; otherwise set as old or new
        if (version == selectedNewVersion)
        {
            // Deselect new version
            selectedNewVersion = 0;
            newVersionText = string.Empty;
        }
        else if (version == selectedOldVersion)
        {
            // Deselect old version
            selectedOldVersion = 0;
            oldVersionText = string.Empty;
        }
        else if (selectedNewVersion == 0 || version > selectedNewVersion)
        {
            // Set as new version (higher version number)
            selectedNewVersion = version;
            newVersionText = text;
        }
        else
        {
            // Set as old version (lower version number)
            selectedOldVersion = version;
            oldVersionText = text;
        }

        // Ensure old version is always less than new version
        if (selectedOldVersion > 0 && selectedNewVersion > 0 && selectedOldVersion > selectedNewVersion)
        {
            // Swap them
            var tempVersion = selectedOldVersion;
            var tempText = oldVersionText;
            selectedOldVersion = selectedNewVersion;
            oldVersionText = newVersionText;
            selectedNewVersion = tempVersion;
            newVersionText = tempText;
        }
    }

    private string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text))
            return string.Empty;

        if (text.Length <= maxLength)
            return text;

        return text.Substring(0, maxLength) + "...";
    }

    private void SetMessage(string msg, bool error)
    {
        message = msg;
        isError = error;
    }

    private void SetViewMode(string mode)
    {
        selectedViewMode = mode;
    }

    private async Task ConfirmDelete(string promptId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete prompt '{promptId}'? This action cannot be undone."))
        {
            await DeletePrompt(promptId);
        }
    }

    private async Task DeletePrompt(string promptId)
    {
        try
        {
            isLoading = true;
            message = string.Empty;
            var response = await Http.DeleteAsync($"api/prompts/{promptId}");
            
            if (response.IsSuccessStatusCode)
            {
                SetMessage($"Prompt '{promptId}' deleted successfully.", false);
                await LoadPrompts();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                SetMessage($"Error deleting prompt: {errorContent}", true);
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error deleting prompt: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }
}

