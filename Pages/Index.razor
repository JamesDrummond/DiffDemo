@page "/"
@page "/prompt-history/{PromptId}"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>@(string.IsNullOrWhiteSpace(PromptId) ? "All Prompts" : "Prompt History")</PageTitle>

@if (string.IsNullOrWhiteSpace(PromptId))
{
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>All Prompts</h2>
            <a href="/edit-prompt" class="btn btn-primary">Create New Prompt</a>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert @(isError ? "alert-danger" : "alert-info") alert-dismissible fade show" role="alert">
                @message
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else
        {
            @if (promptDisplayItems == null || !promptDisplayItems.Any())
            {
                <div class="alert alert-info">
                    No prompts found. <a href="/edit-prompt">Create your first prompt</a> to get started.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Prompt ID</th>
                                <th>Version</th>
                                <th>Last Updated</th>
                                <th>Preview</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in promptDisplayItems)
                            {
                                <tr>
                                    <td>
                                        <strong>@item.PromptId</strong>
                                    </td>
                                    <td>
                                        @if (item.ActiveVersion != null)
                                        {
                                            <span class="badge bg-success">
                                                v@(item.ActiveVersion.Version) (Active)
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">None</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.ActiveVersion != null)
                                        {
                                            @item.ActiveVersion.UpdatedAt.ToString("g")
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.ActiveVersion != null)
                                        {
                                            <small class="text-muted">@TruncateText(item.ActiveVersion.Text, 100)</small>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <a href="/edit-prompt/@item.PromptId" class="btn btn-sm btn-primary">Edit</a>
                                        <a href="/prompt-history/@item.PromptId" class="btn btn-sm btn-info">History</a>
                                        <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(item.PromptId)">Delete</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        }
    </div>
}
else
{
<div class="container mt-4">
    <h2>Prompt History - @PromptId</h2>

    <div class="mb-3">
        <a href="/" class="btn btn-secondary">
            ← Back to Prompts
        </a>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert @(isError ? "alert-danger" : "alert-info") alert-dismissible fade show" role="alert">
            @message
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        @if (currentPrompt == null)
        {
            <div class="alert alert-warning">
                Prompt not found. Please create the prompt first.
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-md-4">
                    <h4>Version History</h4>
                    <h5 class="mb-3">Current Version</h5>
                    <div class="mb-3">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-0">Version @(currentPrompt.Version)</h6>
                                    <small>@currentPrompt.UpdatedAt.ToString("g")</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="mb-2 small">@TruncateText(currentPrompt.Text, 100)</p>
                                <div class="d-flex gap-3" @onclick:stopPropagation="true">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" 
                                               id="experimental-@currentPrompt.Version" 
                                               checked="@currentPrompt.IsExperimental"
                                               disabled="@(togglingVersions.Contains($"{PromptId}-{currentPrompt.Version}"))"
                                               @onchange="@((e) => ToggleExperimentalByVersion(currentPrompt.Version, e))" />
                                        <label class="form-check-label" for="experimental-@currentPrompt.Version" title="Testmode">
                                            <small>Test</small>
                                            @if (togglingVersions.Contains($"{PromptId}-{currentPrompt.Version}"))
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                            }
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" 
                                               id="active-@currentPrompt.Version" 
                                               checked="@currentPrompt.IsActivePrompt"
                                               disabled="@(togglingVersions.Contains($"{PromptId}-{currentPrompt.Version}"))"
                                               @onchange="@((e) => ToggleActiveByVersion(currentPrompt.Version, e))" />
                                        <label class="form-check-label" for="active-@currentPrompt.Version" title="Active">
                                            <small>Active</small>
                                            @if (togglingVersions.Contains($"{PromptId}-{currentPrompt.Version}"))
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                            }
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h5 class="mb-3">Historical Versions</h5>
                    <div class="list-group mb-3">
                        @foreach (var historyItem in history.OrderByDescending(h => h.Version))
                        {
                            <div class="list-group-item @((selectedOldVersion == historyItem.Version || selectedNewVersion == historyItem.Version) ? "version-selected" : "")">
                                <div class="d-flex align-items-start">
                                    <a href="#" 
                                       class="flex-grow-1 text-decoration-none text-reset"
                                       @onclick:preventDefault="true"
                                       @onclick="() => SelectVersion(historyItem.Version, historyItem.Text)"
                                       @onclick:stopPropagation="true">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">Version @historyItem.Version</h6>
                                            <small>@(historyItem.ArchivedDateTime?.ToString("g") ?? "N/A")</small>
                                        </div>
                                        <p class="mb-1 small">@TruncateText(historyItem.Text, 100)</p>
                                    </a>
                                    <div class="d-flex flex-column gap-1 ms-2" @onclick:stopPropagation="true">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="experimental-@historyItem.Version" 
                                                   checked="@historyItem.IsExperimental"
                                                   disabled="@(togglingVersions.Contains($"{PromptId}-{historyItem.Version}"))"
                                                   @onchange="@((e) => ToggleExperimentalByVersion(historyItem.Version, e))" />
                                            <label class="form-check-label" for="experimental-@historyItem.Version" title="Testmode">
                                                <small>Test</small>
                                                @if (togglingVersions.Contains($"{PromptId}-{historyItem.Version}"))
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                }
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="active-@historyItem.Version" 
                                                   checked="@historyItem.IsActivePrompt"
                                                   disabled="@(togglingVersions.Contains($"{PromptId}-{historyItem.Version}"))"
                                                   @onchange="@((e) => ToggleActiveByVersion(historyItem.Version, e))" />
                                            <label class="form-check-label" for="active-@historyItem.Version" title="Active">
                                                <small>Active</small>
                                                @if (togglingVersions.Contains($"{PromptId}-{historyItem.Version}"))
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                }
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="col-md-8">
                    @if (selectedOldVersion > 0 && selectedNewVersion > 0)
                    {
                        <div class="card diff-view-card">
                            <div class="card-header diff-view-header">
                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                    <div>
                                        <h4 class="mb-1" style="font-weight: 600; color: #495057;">Difference View</h4>
                                        <p class="mb-0" style="font-size: 0.875rem; color: #6c757d;">
                                            Comparing: <strong>Version @selectedOldVersion</strong> → <strong>Version @selectedNewVersion</strong>
                                        </p>
                                    </div>
                                    <div class="diff-controls-container d-flex align-items-center gap-3 flex-wrap mt-2 mt-md-0">
                                        <div class="diff-control-group d-flex align-items-center">
                                            <span class="diff-control-label me-2">View Mode:</span>
                                            <div class="btn-group" role="group">
                                                <button type="button" 
                                                        class="btn btn-sm @(selectedViewMode == "SideBySide" ? "btn-primary" : "btn-outline-primary")"
                                                        @onclick='() => SetViewMode("SideBySide")'>
                                                    Side-by-Side
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-sm @(selectedViewMode == "Inline" ? "btn-primary" : "btn-outline-primary")"
                                                        @onclick='() => SetViewMode("Inline")'>
                                                    Inline/Unified
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="diff-control-separator"></div>
                                        
                                        <div class="diff-control-group d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-2" id="showLineNumbers" @bind="showLineNumbers" />
                                            <label for="showLineNumbers" class="diff-control-label mb-0" style="cursor: pointer;">Show Line Numbers</label>
                                        </div>
                                        
                                        <div class="diff-control-separator"></div>
                                        
                                        <button class="btn btn-sm btn-primary" @onclick="() => StateHasChanged()">
                                            Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body diff-view-body">
                                <DiffViewer OldText="@oldVersionText" 
                                           NewText="@newVersionText" 
                                           ViewMode="@currentViewMode" 
                                           ShowLineNumbers="@showLineNumbers" />
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="card empty-state-card">
                            <div class="card-body text-center py-5">
                                <div style="font-size: 3rem; color: #6c757d; opacity: 0.5;">↔</div>
                                <h4 class="mt-3">No Versions Selected</h4>
                                <p class="text-muted">Please select two versions from the history to compare them.</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>
}

<link href="css/diff-styles.css" rel="stylesheet" />

<style>
    .version-selected {
        background-color: #6c757d !important;
        color: #fff !important;
    }
    .version-selected h6,
    .version-selected small,
    .version-selected p {
        color: #fff !important;
    }
</style>

@code {
    [Parameter]
    public string PromptId { get; set; } = string.Empty;

    private Prompt? currentPrompt;
    private List<Prompt> history = new();
    private List<PromptDisplayItem>? promptDisplayItems;
    private bool isLoading = false;
    private string message = string.Empty;
    private bool isError = false;

    private class PromptDisplayItem
    {
        public string PromptId { get; set; } = string.Empty;
        public Prompt? ActiveVersion { get; set; }
    }

    private int selectedOldVersion = 0;
    private int selectedNewVersion = 0;
    private string oldVersionText = string.Empty;
    private string newVersionText = string.Empty;
    private bool showLineNumbers = true;
    private string selectedViewMode = "SideBySide";
    private DiffViewer.DiffViewMode currentViewMode => selectedViewMode == "SideBySide" ? DiffViewer.DiffViewMode.SideBySide : DiffViewer.DiffViewMode.Inline;
    private HashSet<string> togglingVersions = new HashSet<string>();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        if (string.IsNullOrWhiteSpace(PromptId))
        {
            await LoadPrompts();
        }
        else
        {
            await LoadHistory();
        }
    }

    private async Task LoadPrompts()
    {
        try
        {
            isLoading = true;
            message = string.Empty;
            
            // Get all prompts (all versions) to find unique PromptIds
            var allPrompts = new List<Prompt>();
            
            // First, get all non-archived prompts
            var activeResponse = await Http.GetFromJsonAsync<List<Prompt>>("api/prompts");
            if (activeResponse != null)
            {
                allPrompts.AddRange(activeResponse);
            }
            
            // Get all unique PromptIds
            var uniquePromptIds = allPrompts.Select(p => p.PromptId).Distinct().ToList();
            
            // For each unique PromptId, find the active version
            promptDisplayItems = new List<PromptDisplayItem>();
            foreach (var promptId in uniquePromptIds)
            {
                // Get all versions for this PromptId
                var versionsResponse = await Http.GetAsync($"api/prompts/{promptId}/versions");
                if (versionsResponse.IsSuccessStatusCode)
                {
                    var versions = await versionsResponse.Content.ReadFromJsonAsync<List<Prompt>>() ?? new List<Prompt>();
                    var activeVersion = versions.FirstOrDefault(p => p.IsActivePrompt);
                    
                    promptDisplayItems.Add(new PromptDisplayItem
                    {
                        PromptId = promptId,
                        ActiveVersion = activeVersion
                    });
                }
            }
            
            // Sort by PromptId
            promptDisplayItems = promptDisplayItems.OrderBy(p => p.PromptId).ToList();
        }
        catch (Exception ex)
        {
            SetMessage($"Error loading prompts: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadHistory()
    {
        if (string.IsNullOrWhiteSpace(PromptId))
        {
            SetMessage("Prompt ID is required.", true);
            return;
        }

        try
        {
            isLoading = true;
            message = string.Empty;

            var promptResponse = await Http.GetAsync($"api/prompts/{PromptId}");
            if (promptResponse.IsSuccessStatusCode)
            {
                currentPrompt = await promptResponse.Content.ReadFromJsonAsync<Prompt>();
            }

            var historyResponse = await Http.GetAsync($"api/prompts/{PromptId}/history");
            if (historyResponse.IsSuccessStatusCode)
            {
                var historyList = await historyResponse.Content.ReadFromJsonAsync<List<Prompt>>();
                history = historyList ?? new List<Prompt>();
            }

            if (currentPrompt != null)
            {
                // Always set current version as the new version
                selectedNewVersion = currentPrompt.Version;
                newVersionText = GetVersionText(currentPrompt.Version);
                
                // Find the most recent history version to use as old version
                if (history.Any())
                {
                    // Get distinct versions from history, ordered by version number
                    var historyVersions = history
                        .GroupBy(p => p.Version)
                        .Select(g => g.First())
                        .OrderByDescending(p => p.Version)
                        .ToList();
                    
                    // Find the most recent history version that's different from current
                    var previousVersion = historyVersions.FirstOrDefault(h => h.Version < currentPrompt.Version);
                    if (previousVersion == null && historyVersions.Any())
                    {
                        // If no version is less than current, use the most recent history version
                        previousVersion = historyVersions.First();
                    }
                    
                    if (previousVersion != null)
                    {
                        selectedOldVersion = previousVersion.Version;
                        oldVersionText = GetVersionText(previousVersion.Version);
                        
                        // Safety check: if texts are the same, try to find a different previous version
                        if (oldVersionText == newVersionText && historyVersions.Count > 1)
                        {
                            // Try starting from the previous version and go backwards
                            foreach (var candidate in historyVersions.Skip(1))
                            {
                                var candidateText = GetVersionText(candidate.Version);
                                if (candidateText != newVersionText)
                                {
                                    selectedOldVersion = candidate.Version;
                                    oldVersionText = candidateText;
                                    break;
                                }
                            }
                        }
                    }
                    else
                    {
                        selectedOldVersion = 0;
                        oldVersionText = string.Empty;
                    }
                }
                else
                {
                    selectedOldVersion = 0;
                    oldVersionText = string.Empty;
                }
            }
            else
            {
                SetMessage("Prompt not found. Please create the prompt first.", true);
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error loading history: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SelectVersion(int version, string text)
    {
        // Get the actual text for this version to ensure we have the correct text
        string actualText = GetVersionText(version);
        if (string.IsNullOrEmpty(actualText))
        {
            actualText = text; // Fallback to passed text if not found
        }

        // Don't allow selecting the current version
        if (currentPrompt != null && version == currentPrompt.Version)
        {
            return;
        }

        // Ensure current version is always set as new version
        if (currentPrompt != null)
        {
            selectedNewVersion = currentPrompt.Version;
            newVersionText = GetVersionText(currentPrompt.Version);
        }

        // When selecting a historical version, update the old version
        if (version == selectedOldVersion)
        {
            // If clicking the old version, deselect it
            selectedOldVersion = 0;
            oldVersionText = string.Empty;
        }
        else
        {
            // Set the selected version as the old version
            selectedOldVersion = version;
            oldVersionText = actualText;
        }

        // Ensure old version is always less than new version (swap if needed)
        if (selectedOldVersion > 0 && selectedNewVersion > 0 && selectedOldVersion > selectedNewVersion)
        {
            // Swap versions and their texts
            var tempVersion = selectedOldVersion;
            var tempText = oldVersionText;
            selectedOldVersion = selectedNewVersion;
            oldVersionText = newVersionText;
            selectedNewVersion = tempVersion;
            newVersionText = tempText;
        }
    }

    private string GetVersionText(int version)
    {
        // Check current prompt first
        if (currentPrompt != null && currentPrompt.Version == version)
        {
            return currentPrompt.Text;
        }

        // Check history
        var historyItem = history.FirstOrDefault(h => h.Version == version);
        if (historyItem != null)
        {
            return historyItem.Text;
        }

        return string.Empty;
    }

    private string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text))
            return string.Empty;

        if (text.Length <= maxLength)
            return text;

        return text.Substring(0, maxLength) + "...";
    }

    private void SetMessage(string msg, bool error)
    {
        message = msg;
        isError = error;
    }

    private void SetViewMode(string mode)
    {
        selectedViewMode = mode;
    }

    private async Task ConfirmDelete(string promptId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete prompt '{promptId}'? This action cannot be undone."))
        {
            await DeletePrompt(promptId);
        }
    }

    private async Task DeletePrompt(string promptId)
    {
        try
        {
            isLoading = true;
            message = string.Empty;
            var response = await Http.DeleteAsync($"api/prompts/{promptId}");
            
            if (response.IsSuccessStatusCode)
            {
                SetMessage($"Prompt '{promptId}' deleted successfully.", false);
                await LoadPrompts();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                SetMessage($"Error deleting prompt: {errorContent}", true);
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error deleting prompt: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ToggleExperimentalByVersion(int version, ChangeEventArgs e)
    {
        if (string.IsNullOrWhiteSpace(PromptId))
            return;

        var versionKey = $"{PromptId}-{version}";
        
        try
        {
            togglingVersions.Add(versionKey);
            var newValue = e.Value != null && (bool)e.Value;
            
            var response = await Http.PutAsJsonAsync($"api/prompts/{PromptId}/versions/{version}/experimental", newValue);
            
            if (response.IsSuccessStatusCode)
            {
                // Update the prompt in the appropriate list
                if (currentPrompt != null && currentPrompt.Version == version)
                {
                    currentPrompt.IsExperimental = newValue;
                }
                else
                {
                    var historyItem = history.FirstOrDefault(h => h.Version == version);
                    if (historyItem != null)
                    {
                        historyItem.IsExperimental = newValue;
                    }
                }
                SetMessage($"Testmode for {PromptId} version {version} set to {(newValue ? "on" : "off")}", false);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                SetMessage($"Error toggling testmode: {errorContent}", true);
                // Reload to revert the state
                await LoadHistory();
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error toggling testmode: {ex.Message}", true);
            // Reload to revert the state
            await LoadHistory();
        }
        finally
        {
            togglingVersions.Remove(versionKey);
        }
    }

    private async Task ToggleActiveByVersion(int version, ChangeEventArgs e)
    {
        if (string.IsNullOrWhiteSpace(PromptId))
            return;

        var newValue = e.Value != null && (bool)e.Value;
        
        // If unchecking, prevent it and show a message
        if (!newValue)
        {
            SetMessage("Cannot deactivate a version. Please activate another version instead.", true);
            // Revert the checkbox by reloading
            await LoadHistory();
            return;
        }

        // If checking, show confirmation dialog
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to set version {version} as the active version? This will deactivate all other versions of '{PromptId}'.");
        
        if (!confirmed)
        {
            // Revert the checkbox by reloading
            await LoadHistory();
            return;
        }

        var versionKey = $"{PromptId}-{version}";
        
        try
        {
            togglingVersions.Add(versionKey);
            
            var response = await Http.PostAsync($"api/prompts/{PromptId}/versions/{version}/set-active", null);
            
            if (response.IsSuccessStatusCode)
            {
                SetMessage($"Version {version} set as active for {PromptId}.", false);
                // Reload history to update all versions' active states
                await LoadHistory();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                SetMessage($"Error setting version as active: {errorContent}", true);
                // Reload to revert the state
                await LoadHistory();
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error setting version as active: {ex.Message}", true);
            // Reload to revert the state
            await LoadHistory();
        }
        finally
        {
            togglingVersions.Remove(versionKey);
        }
    }
}


