@page "/edit-prompt"
@page "/edit-prompt/{PromptId}"
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Edit Prompt</PageTitle>

<div class="container mt-4">
    <div class="mb-3">
        <a href="/prompts" class="btn btn-link p-0">
            ‚Üê Back to Prompts
        </a>
    </div>
    <h2>Edit Prompt</h2>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert @(isError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
            @message
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="mb-3">
        <label for="promptId" class="form-label">Prompt ID</label>
        <input type="text" class="form-control" id="promptId" @bind="promptId" disabled="@(isLoading || isExistingPrompt)" readonly="@isExistingPrompt" />
        @if (isExistingPrompt)
        {
            <small class="text-muted">Prompt ID cannot be changed once set.</small>
        }
    </div>

    <div class="mb-3">
        <label for="promptText" class="form-label">Prompt Text</label>
        <textarea class="form-control" id="promptText" rows="15" @bind="promptText" disabled="@isLoading"></textarea>
        @if (string.IsNullOrWhiteSpace(promptText))
        {
            <small class="text-danger">Prompt text cannot be empty.</small>
        }
    </div>

    <div class="mb-3">
        @if (currentPrompt != null)
        {
            <p class="text-muted">Current Version: <strong>@currentPrompt.Version</strong></p>
            <p class="text-muted">Last Updated: <strong>@currentPrompt.UpdatedAt.ToString("g")</strong></p>
        }
        else
        {
            <p class="text-info">This is a new prompt. It will be created as version 1.</p>
        }
    </div>

    <div class="mb-3">
        <button class="btn btn-primary" @onclick="SavePrompt" disabled="@(isLoading || string.IsNullOrWhiteSpace(promptText) || string.IsNullOrWhiteSpace(promptId))">
            @if (isLoading)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span> Saving...</span>
            }
            else
            {
                <span>Save Prompt</span>
            }
        </button>
        <button class="btn btn-secondary ms-2" @onclick="LoadPrompt" disabled="@(isLoading || string.IsNullOrWhiteSpace(promptId))">
            Load Prompt
        </button>
        <a href="/prompt-history/@promptId" class="btn btn-info ms-2" style="@(string.IsNullOrWhiteSpace(promptId) || currentPrompt == null ? "display:none;" : "")">
            View History
        </a>
    </div>
</div>

@code {
    [Parameter]
    public string? PromptId { get; set; }

    private string promptId = "default";
    private string promptText = string.Empty;
    private bool isExperimental = false;
    private Prompt? currentPrompt;
    private bool isLoading = false;
    private string message = string.Empty;
    private bool isError = false;
    private bool isExistingPrompt = false;
    private string? originalPromptId = null;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(PromptId))
        {
            promptId = PromptId;
            await LoadPrompt();
        }
    }

    private async Task LoadPrompt()
    {
        if (string.IsNullOrWhiteSpace(promptId))
        {
            SetMessage("Prompt ID cannot be empty.", true);
            return;
        }

        try
        {
            isLoading = true;
            message = string.Empty;
            var response = await Http.GetAsync($"api/prompts/{promptId}");
            
            if (response.IsSuccessStatusCode)
            {
                currentPrompt = await response.Content.ReadFromJsonAsync<Prompt>();
                if (currentPrompt != null)
                {
                    promptText = currentPrompt.Text;
                    isExperimental = currentPrompt.IsExperimental;
                    isExistingPrompt = true;
                    originalPromptId = currentPrompt.PromptId;
                    SetMessage($"Loaded prompt version {currentPrompt.Version}.", false);
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                currentPrompt = null;
                promptText = string.Empty;
                isExistingPrompt = false;
                originalPromptId = null;
                SetMessage("Prompt not found. This will be a new prompt.", false);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                SetMessage($"Error loading prompt: {errorContent}", true);
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error loading prompt: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SavePrompt()
    {
        if (string.IsNullOrWhiteSpace(promptId))
        {
            SetMessage("Prompt ID cannot be empty.", true);
            return;
        }

        if (string.IsNullOrWhiteSpace(promptText))
        {
            SetMessage("Prompt text cannot be empty.", true);
            return;
        }

        try
        {
            isLoading = true;
            message = string.Empty;

            var prompt = new Prompt
            {
                PromptId = promptId,
                Text = promptText
            };

            // Don't set Id - let MongoDB generate a new _id for the new version
            // Only PromptId (logical ID) should be preserved
            // The PromptId cannot be changed because the field is readonly when editing existing prompts

            var response = await Http.PostAsJsonAsync("api/prompts", prompt);
            
            if (response.IsSuccessStatusCode)
            {
                currentPrompt = await response.Content.ReadFromJsonAsync<Prompt>();
                if (currentPrompt != null)
                {
                    promptText = currentPrompt.Text;
                    isExperimental = currentPrompt.IsExperimental;
                    isExistingPrompt = true;
                    originalPromptId = currentPrompt.PromptId;
                    SetMessage($"Prompt saved successfully! Version {currentPrompt.Version} created at {currentPrompt.UpdatedAt:g}", false);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                SetMessage($"Error saving prompt: {errorContent}", true);
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error saving prompt: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SetMessage(string msg, bool error)
    {
        message = msg;
        isError = error;
    }
}

