@page "/edit-prompt"
@page "/edit-prompt/{PromptId}"
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Edit Prompt</PageTitle>

<div class="container mt-4">
    <div class="mb-3">
        <a href="/" class="btn btn-link p-0">
            ‚Üê Back to Prompts
        </a>
    </div>
    <h2>Edit Prompt</h2>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert @(isError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
            @message
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="mb-3">
        <label for="promptId" class="form-label">Prompt ID</label>
        <input type="text" class="form-control @(IsPromptIdValid ? "" : "is-invalid")" id="promptId" @bind="promptId" @bind:event="oninput" disabled="@(isLoading || isExistingPrompt)" readonly="@isExistingPrompt" />
        @if (isExistingPrompt)
        {
            <small class="text-muted">Prompt ID cannot be changed once set.</small>
        }
        else if (!string.IsNullOrWhiteSpace(promptId) && !IsPromptIdValid)
        {
            <small class="text-danger">Prompt ID must be a valid GUID format.</small>
        }
    </div>

    <div class="mb-3">
        @if (allVersions.Count > 0)
        {
            <label for="versionSelect" class="form-label">Select Version</label>
            <select class="form-select" id="versionSelect" value="@selectedVersion" @onchange="OnVersionChanged" disabled="@isLoading">
                @foreach (var version in allVersions)
                {
                    var isActive = version.ArchivedAtDateTime == null;
                    var displayText = $"Version {version.Version} - {version.UpdatedAtDateTime:g}";
                    if (isActive)
                    {
                        displayText += " (Active)";
                    }
                    <option value="@version.Version">@displayText</option>
                }
            </select>
        }
    </div>

    <div class="mb-3">
        @if (currentPrompt != null)
        {
            <p class="text-muted">Current Version: <strong>@currentPrompt.Version</strong></p>
            <p class="text-muted">Last Updated: <strong>@currentPrompt.UpdatedAtDateTime?.ToString("g")</strong></p>
            @if (allVersions.Count > 0)
            {
                var nextVersion = allVersions.Max(v => v.Version) + 1;
                <p class="text-info">Next save will create version <strong>@nextVersion</strong></p>
            }
        }
        else if (allVersions.Count > 0)
        {
            var nextVersion = allVersions.Max(v => v.Version) + 1;
            <p class="text-info">Next save will create version <strong>@nextVersion</strong></p>
        }
        else
        {
            <p class="text-info">This is a new prompt. It will be created as version 1.</p>
        }
    </div>

    <div class="mb-3">
        <label for="promptText" class="form-label">Prompt Text</label>
        <textarea class="form-control" id="promptText" rows="15" @bind="promptText" disabled="@isLoading"></textarea>
        @if (string.IsNullOrWhiteSpace(promptText))
        {
            <small class="text-danger">Prompt text cannot be empty.</small>
        }
    </div>

    <div class="mb-3">
        <button class="btn btn-primary" @onclick="SavePrompt" disabled="@(isLoading || string.IsNullOrWhiteSpace(promptText) || !IsPromptIdValid)">
            @if (isLoading)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span> Saving...</span>
            }
            else
            {
                <span>Save Prompt</span>
            }
        </button>
        <button class="btn btn-secondary ms-2" @onclick="LoadPrompt" disabled="@(isLoading || !IsPromptIdValid)">
            Load Prompt
        </button>
        <a href="/prompt-history/@promptId" class="btn btn-info ms-2" style="@(!IsPromptIdValid || currentPrompt == null ? "display:none;" : "")">
            View History
        </a>
    </div>
</div>

@code {
    [Parameter]
    public string? PromptId { get; set; }

    private string promptId = string.Empty;
    private string promptText = string.Empty;
    private bool isExperimental = false;
    private Prompt? currentPrompt;
    private bool isLoading = false;
    private string message = string.Empty;
    private bool isError = false;
    private bool isExistingPrompt = false;
    private Guid? originalPromptId = null;
    private List<Prompt> allVersions = new List<Prompt>();
    private int selectedVersion = 0;

    private bool IsPromptIdValid => !string.IsNullOrWhiteSpace(promptId) && Guid.TryParse(promptId, out _);

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(PromptId))
        {
            if (Guid.TryParse(PromptId, out _))
            {
                promptId = PromptId;
                await LoadPrompt();
            }
            else
            {
                SetMessage("Invalid Prompt ID format.", true);
            }
        }
        else
        {
            // Generate a new GUID for creating a new prompt
            promptId = Guid.NewGuid().ToString();
        }
    }

    private async Task LoadPrompt()
    {
        if (string.IsNullOrWhiteSpace(promptId) || !Guid.TryParse(promptId, out var promptIdGuid))
        {
            SetMessage("Prompt ID cannot be empty and must be a valid GUID.", true);
            return;
        }

        try
        {
            isLoading = true;
            message = string.Empty;
            
            // Load all versions
            var versionsResponse = await Http.GetAsync($"api/prompts/{promptIdGuid}/versions");
            if (versionsResponse.IsSuccessStatusCode)
            {
                allVersions = await versionsResponse.Content.ReadFromJsonAsync<List<Prompt>>() ?? new List<Prompt>();
            }
            
            // Load the active version (or latest if no active version)
            var response = await Http.GetAsync($"api/prompts/{promptIdGuid}");
            
            if (response.IsSuccessStatusCode)
            {
                currentPrompt = await response.Content.ReadFromJsonAsync<Prompt>();
                if (currentPrompt != null)
                {
                    promptText = currentPrompt.Text;
                    isExperimental = currentPrompt.IsExperimental;
                    isExistingPrompt = true;
                    originalPromptId = currentPrompt.PromptId;
                    selectedVersion = currentPrompt.Version;
                    SetMessage($"Loaded prompt version {currentPrompt.Version}.", false);
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // If no active version but we have versions, load the latest one
                if (allVersions.Count > 0)
                {
                    currentPrompt = allVersions.OrderByDescending(v => v.Version).First();
                    promptText = currentPrompt.Text;
                    isExperimental = currentPrompt.IsExperimental;
                    isExistingPrompt = true;
                    originalPromptId = currentPrompt.PromptId;
                    selectedVersion = currentPrompt.Version;
                    SetMessage($"Loaded prompt version {currentPrompt.Version} (archived).", false);
                }
                else
                {
                    currentPrompt = null;
                    promptText = string.Empty;
                    isExistingPrompt = false;
                    originalPromptId = null;
                    selectedVersion = 0;
                    SetMessage("Prompt not found. This will be a new prompt.", false);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                SetMessage($"Error loading prompt: {errorContent}", true);
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error loading prompt: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnVersionChanged(ChangeEventArgs e)
    {
        if (e.Value != null && int.TryParse(e.Value.ToString(), out int version))
        {
            await LoadVersion(version);
        }
    }

    private async Task LoadVersion(int version)
    {
        if (string.IsNullOrWhiteSpace(promptId) || !Guid.TryParse(promptId, out var promptIdGuid))
        {
            return;
        }

        try
        {
            isLoading = true;
            message = string.Empty;
            
            var response = await Http.GetAsync($"api/prompts/{promptIdGuid}/history/{version}");
            
            if (response.IsSuccessStatusCode)
            {
                var versionPrompt = await response.Content.ReadFromJsonAsync<Prompt>();
                if (versionPrompt != null)
                {
                    currentPrompt = versionPrompt;
                    promptText = versionPrompt.Text;
                    isExperimental = versionPrompt.IsExperimental;
                    selectedVersion = versionPrompt.Version;
                    SetMessage($"Loaded prompt version {versionPrompt.Version}.", false);
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // Try to get from allVersions list if it's not found in the API
                var versionPrompt = allVersions.FirstOrDefault(v => v.Version == version);
                if (versionPrompt != null)
                {
                    currentPrompt = versionPrompt;
                    promptText = versionPrompt.Text;
                    isExperimental = versionPrompt.IsExperimental;
                    selectedVersion = versionPrompt.Version;
                    SetMessage($"Loaded prompt version {versionPrompt.Version}.", false);
                }
                else
                {
                    SetMessage($"Version {version} not found.", true);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                SetMessage($"Error loading version: {errorContent}", true);
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error loading version: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SavePrompt()
    {
        if (string.IsNullOrWhiteSpace(promptId) || !Guid.TryParse(promptId, out var promptIdGuid))
        {
            SetMessage("Prompt ID cannot be empty and must be a valid GUID.", true);
            return;
        }

        if (string.IsNullOrWhiteSpace(promptText))
        {
            SetMessage("Prompt text cannot be empty.", true);
            return;
        }

        try
        {
            isLoading = true;
            message = string.Empty;

            var prompt = new Prompt
            {
                PromptId = promptIdGuid,
                Text = promptText
            };

            // Don't set Id - let MongoDB generate a new _id for the new version
            // Only PromptId (logical ID) should be preserved
            // The PromptId cannot be changed because the field is readonly when editing existing prompts

            var response = await Http.PostAsJsonAsync("api/prompts", prompt);
            
            if (response.IsSuccessStatusCode)
            {
                currentPrompt = await response.Content.ReadFromJsonAsync<Prompt>();
                if (currentPrompt != null)
                {
                    promptText = currentPrompt.Text;
                    isExperimental = currentPrompt.IsExperimental;
                    isExistingPrompt = true;
                    originalPromptId = currentPrompt.PromptId;
                    selectedVersion = currentPrompt.Version;
                    
                    // Reload all versions to update the dropdown
                    var versionsResponse = await Http.GetAsync($"api/prompts/{promptIdGuid}/versions");
                    if (versionsResponse.IsSuccessStatusCode)
                    {
                        allVersions = await versionsResponse.Content.ReadFromJsonAsync<List<Prompt>>() ?? new List<Prompt>();
                    }
                    
                    SetMessage($"Prompt saved successfully! Version {currentPrompt.Version} created at {currentPrompt.UpdatedAtDateTime:g}", false);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                SetMessage($"Error saving prompt: {errorContent}", true);
            }
        }
        catch (Exception ex)
        {
            SetMessage($"Error saving prompt: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SetMessage(string msg, bool error)
    {
        message = msg;
        isError = error;
    }
}

